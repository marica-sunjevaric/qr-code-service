var qrCode = new QRCode({
    content: "Hello World",
    padding: 0,
    ecl: "L",
    width: 300,
    height: 300
});
var url = window.location.href;
var params = getParams(url);
var keys = Object.keys(qrCode.options);
var vCard = ['N', 'FN', 'ORG', 'TITLE', 'ADR', 'TEL;WORK;VOICE', 'TEL;CELL', 'TEL;FAX', 'EMAIL;WORK;INTERNET', 'URL'];

// get all parameters
function getParams(url) {
    var queryString = url.substring(url.indexOf('?') + 1);
    var paramsArr = queryString.split('&');
    var params = [];
    for (i = 0; i < paramsArr.length; i++) {
        var keyValuePair = paramsArr[i].split('=');
        params.push({
            name: keyValuePair[0],
            value: keyValuePair[1]
        });
    }
    return params;
}

//qr code generated by url parameters
if (url.includes("?")) {
    for (j = 0; j < keys.length; j++) {
        for (k = 0; k < params.length; k++) {
            if (keys[j] == params[k].name) {
                if (typeof (qrCode.options[keys[j]]) == 'number') {
                    qrCode.options[keys[j]] = parseFloat(params[k].value);
                } else if (params[k].name == "content") {
                    qrCode.options[keys[j]] = params[k].value.replace(/%20/g, " ").replace(/%0A/g, "\n");
                    for (i = 0; i < vCard.length; i++) {
                        if (params[k].value.indexOf(vCard[i]) > -1) {
                            qrCode.options[keys[j]] = 'BEGIN:VCARD' + '\n' + 'VERSION:3.0' + params[k].value.replace(/%20/g, " ").replace(/%0A/g, "\n") + '\n' + 'END:VCARD';
                        }
                    }
                }  else if (params[k].name == "background" || params[k].name == "color"){
                    qrCode.options[keys[j]] =  params[k].value.replace(/%23/g, "#");
                } else {
                    qrCode.options[keys[j]] = params[k].value;
                }
            }
        }
    }
    var qr = new QRCode({
        content: qrCode.options.content,
        padding: qrCode.options.padding,
        width: qrCode.options.width,
        height: qrCode.options.height,
        ecl: qrCode.options.ecl,
        background: qrCode.options.background,
        color: qrCode.options.color
    });
    document.getElementById("container").innerHTML = qr.svg();
}

//select type of content
$('input:radio[name="contentType"]').change(function () {
    if(this.checked && this.value == "vCard") {
        $('#vCard1').css({
            'display': 'flex',
            'flex-direction': 'column'
        });
        $('.url').css('display', 'none');
        $('#text').css('display', 'none');
        var qrcode = getValuesVCard();
        document.getElementById("container").innerHTML = qrcode.svg();
    }
    else if (this.checked && this.value == "url") {
        $('.url').css('display', 'block');
        $('#text').css('display', 'none');
        $('#vCard1').css('display', 'none');
        var qrcode = getValuesUrl();
        document.getElementById("container").innerHTML = qrcode.svg();
    }
    else if (this.checked && this.value == "content") {
        $('.url').css('display', 'none');
        $('#text').css('display', 'block');
        $('#vCard1').css('display', 'none');
        var qrcode = getValues();
        document.getElementById("container").innerHTML = qrcode.svg();
    }
})

// set content
$('#text').on('input',function(e){
    var qrcode = getValues();
    document.getElementById("container").innerHTML = qrcode.svg();
})

// set content - url
$('#textUrl').on('input',function(e){
    var qrcode = getValuesUrl();
    document.getElementById("container").innerHTML = qrcode.svg();
})

//scale - slider
var first = document.getElementById('width');
var second = document.getElementById('height');
$("#scale").on("change", function(){
    first.value = this.value;
    second.value = this.value;
    if ($('#content').is(':checked')) {
        var qrcode = getValues();
        document.getElementById("container").innerHTML = qrcode.svg();
    } else if ($('#url').is(':checked')) {
        var qrcode = getValuesUrl();
        document.getElementById("container").innerHTML = qrcode.svg();
    } else if ($('#vCard').is(':checked')) {
        var qrcode = getValuesVCard();
        document.getElementById("container").innerHTML = qrcode.svg();
    }
})

//options
$('#quiet, #eclevel, #background, #color').on('input', function() {
    if ($('#content').is(':checked')) {
        var qrcode = getValues();
        document.getElementById("container").innerHTML = qrcode.svg();
    } else if ($('#url').is(':checked')) {
        var qrcode = getValuesUrl();
        document.getElementById("container").innerHTML = qrcode.svg();
    } else if ($('#vCard').is(':checked')) {
        var qrcode = getValuesVCard();
        document.getElementById("container").innerHTML = qrcode.svg();
    }
})

//vCard options
$('#name, #name1, #cell, #work, #fax, #email, #company, #company1, #street, #city, #city1, #state, #country, #website').on('change', function() {
    $('#textvCard').val('BEGIN:VCARD' + '\n' +
        'VERSION:3.0'  + '\n' + 'N:' +
        $('#name1').val() + ';' +
        $('#name').val() + '\nFN:' +
        $('#name').val() + '' +
        $('#name1').val() + '\nORG:' +
        $('#company').val() + '\nTITLE:' +
        $('#company1').val() + '\nADR:' +
        $('#street').val() + ';' +
        $('#city').val() + ';' +
        $('#state').val() + ';' +
        $('#city1').val() + ';' +
        $('#country').val() + '\nTEL;WORK;VOICE:' +
        $('#work').val() + '\nTEL;CELL:' +
        $('#cell').val() + '\nTEL;FAX:' +
        $('#fax').val() + '\nEMAIL;WORK;INTERNET:' +
        $('#email').val() + '\nURL:' +
        $('#website').val() + '\nEND:VCARD'
    );
    var qrCode = getValuesVCard();
    document.getElementById("container").innerHTML = qrCode.svg();
})

//values for new text qr code
function getValues(){
    var qrCode = new QRCode({
        content: $('#text').val(),
        padding: parseInt($('#quiet').val()),
        ecl: $('#eclevel').val(),
        width:  $('#width').val(),
        height:  $('#height').val(),
        color:  $('#color').val(),
        background:  $('#background').val()
    });
    return qrCode;
}

//values for new url qr code
function getValuesUrl(){
    var qrCode = new QRCode({
        content: $('#textUrl').val(),
        padding: parseInt($('#quiet').val()),
        ecl: $('#eclevel').val(),
        width:  $('#width').val(),
        height:  $('#height').val(),
        color:  $('#color').val(),
        background:  $('#background').val()
    });
    return qrCode;
}

//values for new vCard qr code
function getValuesVCard(){
    var qrCode = new QRCode({
        content: $('#textvCard').val(),
        padding: parseInt($('#quiet').val()),
        ecl: $('#eclevel').val(),
        width:  $('#width').val(),
        height:  $('#height').val(),
        color:  $('#color').val(),
        background:  $('#background').val()
    });
    return qrCode;
}

//button SVG
$('#btnSVG').on('click', function() {
    forceDownload ("QRCode.svg");
});

//parametar for download
for (i=0 ; i<params.length; i++) {
    if (params[i].name == "OutputFormat" && params[i].value == "SVG") {
        forceDownload("QRCode.svg");
    }
}

//download function for button SVG
function forceDownload(fileName){
    var svg = document.getElementsByTagName("svg")[0];
    var serializer = new XMLSerializer();
    var source = serializer.serializeToString(svg);
    if(!source.match(/^<svg[^>]+xmlns="http\:\/\/www\.w3\.org\/2000\/svg"/))
    {
        source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
    }
    if(!source.match(/^<svg[^>]+"http\:\/\/www\.w3\.org\/1999\/xlink"/))
    {
        source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
    }
    source = '<?xml version="1.0" standalone="no"?>\r\n' + source;
    var url = "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(source);
    var tag = document.createElement('a');
    tag.href = url;
    tag.download = fileName;
    document.body.appendChild(tag);
    tag.click();
    document.body.removeChild(tag);
}

//set cookie
function createCookie(name,value,minutes) {
    if (minutes) {
        var date = new Date();
        date.setTime(date.getTime()+(minutes*60*1000));
        var expires = "; expires="+date.toGMTString();
    } else {
        var expires = "";
    }
    document.cookie = name+"="+value+expires+"; path=/";
}
//get cookie
function getCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for(var i=0;i < ca.length;i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1,c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
    }
    return null;
}

